Return-Path: <freedreno-bounces@lists.freedesktop.org>
X-Original-To: lists+freedreno@lfdr.de
Delivered-To: lists+freedreno@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 67F163D5C56
	for <lists+freedreno@lfdr.de>; Mon, 26 Jul 2021 16:56:52 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1C1FC6EC27;
	Mon, 26 Jul 2021 14:56:51 +0000 (UTC)
X-Original-To: freedreno@lists.freedesktop.org
Delivered-To: freedreno@lists.freedesktop.org
Received: from mail-pl1-x62b.google.com (mail-pl1-x62b.google.com
 [IPv6:2607:f8b0:4864:20::62b])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 44D816EC27;
 Mon, 26 Jul 2021 14:56:49 +0000 (UTC)
Received: by mail-pl1-x62b.google.com with SMTP id n10so12034629plf.4;
 Mon, 26 Jul 2021 07:56:49 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=rnP/gkcL5lHTpvD1psUDDCzdJhpjhd83ZXQCggS2n0o=;
 b=YGxBHCncLsETFRbU+qTbM8JfECEBgbvAtRcLyRo9+0qkAj7wHah2FToX9uTUvQJaEM
 PaGgDOf3B3F/2CxoaEsQPY4qWqle5Ekg/4zoPa2rdFt5XQ9Duex5B/4ecZT8KRJ7uRPN
 cU/WtId/RZyOW0tgg3qn+yGv2dUIGBDKk+10VHYraZ5RdWX6aF8YUB4k7cLZQUfKiBJ0
 gRX1Tjwh8pYWrCNRtNL+zqBN1uX8eT+ZWCM4LN08jNXnY2P9tFg20CR8hR9C9gS4anXh
 kYsHP927WPbEKJTRIKui6zkItHRTWCRtmi6SiYpH5b/VYmZvTLZrdlBffQCGNCvNEvXq
 3PmQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=rnP/gkcL5lHTpvD1psUDDCzdJhpjhd83ZXQCggS2n0o=;
 b=VtDP/RjT4rnDrEHjfa9u/NVyTxE5DPvp2hrfc/kWyUmcsC4weJNAnlEWgnrGSKgDeX
 SM0J8xrYXSwy6U+5x+JzfCRgoYtkZYRRIkYm15tGE9D4zGIwqTmhOsn8YiYy5+d2os4e
 PxBVVSsJ0DY40r+g9nLgnl2vzCX+6xO/UZmdMmecoUuoNuVTx48Y+kWqG6u1h2w/tzks
 Ky2l4Eqc5rsOBkSQdKUWxB1dndcvLP9o/p3DKdqpA82dLk+PlxrJ3gYrf02nQINexTsv
 d1cYo1FUrs3sDLQI3BnTZh/IjKeAmFgnKTKRSz8s6aTTDCaNSxJC/yVDefT9z09vALsS
 yktw==
X-Gm-Message-State: AOAM531lq13dOYlumEQjMzms9fRYdA9syMDn3HcB6plfjGk9+PrmcgUQ
 xM5VA1NQPHwEEv/KV2B7yyLn/4a5Jeo3xg==
X-Google-Smtp-Source: ABdhPJxEejnXRK8kJeqZkTymDjicJb1JnBke1f6bW2uDBbVFDcEppw+sLhQsbyffaEWfGz0JmPf1Vw==
X-Received: by 2002:a62:61c3:0:b029:35b:cb61:d2c3 with SMTP id
 v186-20020a6261c30000b029035bcb61d2c3mr18691483pfb.62.1627311408266; 
 Mon, 26 Jul 2021 07:56:48 -0700 (PDT)
Received: from localhost ([2601:1c0:5200:a6:307:a401:7b76:c6e5])
 by smtp.gmail.com with ESMTPSA id m2sm22795561pja.52.2021.07.26.07.56.46
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 26 Jul 2021 07:56:47 -0700 (PDT)
From: Rob Clark <robdclark@gmail.com>
To: dri-devel@lists.freedesktop.org
Date: Mon, 26 Jul 2021 08:00:20 -0700
Message-Id: <20210726150038.2187631-7-robdclark@gmail.com>
X-Mailer: git-send-email 2.31.1
In-Reply-To: <20210726150038.2187631-1-robdclark@gmail.com>
References: <20210726150038.2187631-1-robdclark@gmail.com>
MIME-Version: 1.0
Subject: [Freedreno] [PATCH v2 06/12] drm/msm: Consolidate submit bo state
X-BeenThere: freedreno@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Freedreno graphics driver community testing & development
 <freedreno.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/freedreno>,
 <mailto:freedreno-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/freedreno>
List-Post: <mailto:freedreno@lists.freedesktop.org>
List-Help: <mailto:freedreno-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/freedreno>,
 <mailto:freedreno-request@lists.freedesktop.org?subject=subscribe>
Cc: Rob Clark <robdclark@chromium.org>,
 "open list:DRM DRIVER FOR MSM ADRENO GPU"
 <freedreno@lists.freedesktop.org>, David Airlie <airlied@linux.ie>,
 "open list:DRM DRIVER FOR MSM ADRENO GPU" <linux-arm-msm@vger.kernel.org>,
 open list <linux-kernel@vger.kernel.org>, Rob Clark <robdclark@gmail.com>,
 Daniel Vetter <daniel@ffwll.ch>, Sean Paul <sean@poorly.run>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: freedreno-bounces@lists.freedesktop.org
Sender: "Freedreno" <freedreno-bounces@lists.freedesktop.org>

RnJvbTogUm9iIENsYXJrIDxyb2JkY2xhcmtAY2hyb21pdW0ub3JnPgoKTW92ZSBhbGwgdGhlIGxv
Y2tlZC9hY3RpdmUvcGlubmVkIHN0YXRlIGhhbmRsaW5nIHRvIG1zbV9nZW1fc3VibWl0LmMuCklu
IHBhcnRpY3VsYXIsIGZvciBkcm0vc2NoZWR1bGVyLCB3ZSdsbCBuZWVkIHRvIGRvIGFsbCB0aGlz
IGJlZm9yZQpwdXNoaW5nIHRoZSBzdWJtaXQgam9iIHRvIHRoZSBzY2hlZHVsZXIuICBCdXQgd2hp
bGUgd2UncmUgYXQgaXQgd2UgY2FuCmdldCByaWQgb2YgdGhlIGR1cGljYXRlIHBpbiBhbmQgcmVm
Y250LgoKU2lnbmVkLW9mZi1ieTogUm9iIENsYXJrIDxyb2JkY2xhcmtAY2hyb21pdW0ub3JnPgpB
Y2tlZC1ieTogQ2hyaXN0aWFuIEvDtm5pZyA8Y2hyaXN0aWFuLmtvZW5pZ0BhbWQuY29tPgotLS0K
IGRyaXZlcnMvZ3B1L2RybS9tc20vbXNtX2dlbS5oICAgICAgICB8ICAyICsKIGRyaXZlcnMvZ3B1
L2RybS9tc20vbXNtX2dlbV9zdWJtaXQuYyB8IDkyICsrKysrKysrKysrKysrKysrKysrKystLS0t
LS0KIGRyaXZlcnMvZ3B1L2RybS9tc20vbXNtX2dwdS5jICAgICAgICB8IDI5ICstLS0tLS0tLQog
MyBmaWxlcyBjaGFuZ2VkLCA3NSBpbnNlcnRpb25zKCspLCA0OCBkZWxldGlvbnMoLSkKCmRpZmYg
LS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vbXNtL21zbV9nZW0uaCBiL2RyaXZlcnMvZ3B1L2RybS9t
c20vbXNtX2dlbS5oCmluZGV4IDcxY2NmODdhNjQ2Yi4uZGEzYWY3MDJhNmM4IDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vbXNtL21zbV9nZW0uaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vbXNt
L21zbV9nZW0uaApAQCAtMzYxLDYgKzM2MSw4IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCBtc21fZ2Vt
X3N1Ym1pdF9wdXQoc3RydWN0IG1zbV9nZW1fc3VibWl0ICpzdWJtaXQpCiAJa3JlZl9wdXQoJnN1
Ym1pdC0+cmVmLCBfX21zbV9nZW1fc3VibWl0X2Rlc3Ryb3kpOwogfQogCit2b2lkIG1zbV9zdWJt
aXRfcmV0aXJlKHN0cnVjdCBtc21fZ2VtX3N1Ym1pdCAqc3VibWl0KTsKKwogLyogaGVscGVyIHRv
IGRldGVybWluZSBvZiBhIGJ1ZmZlciBpbiBzdWJtaXQgc2hvdWxkIGJlIGR1bXBlZCwgdXNlZCBm
b3IgYm90aAogICogZGV2Y29yZWR1bXAgYW5kIGRlYnVnZnMgY21kc3RyZWFtIGR1bXBpbmc6CiAg
Ki8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9tc20vbXNtX2dlbV9zdWJtaXQuYyBiL2Ry
aXZlcnMvZ3B1L2RybS9tc20vbXNtX2dlbV9zdWJtaXQuYwppbmRleCA4YWJkNzQzYWRmYjAuLjRm
MDJmYTNjNzhmOSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL21zbS9tc21fZ2VtX3N1Ym1p
dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9tc20vbXNtX2dlbV9zdWJtaXQuYwpAQCAtMjMsOCAr
MjMsOCBAQAogCiAvKiBtYWtlIHN1cmUgdGhlc2UgZG9uJ3QgY29uZmxpY3Qgdy8gTVNNX1NVQk1J
VF9CT194ICovCiAjZGVmaW5lIEJPX1ZBTElEICAgIDB4ODAwMCAgIC8qIGlzIGN1cnJlbnQgYWRk
ciBpbiBjbWRzdHJlYW0gY29ycmVjdC92YWxpZD8gKi8KLSNkZWZpbmUgQk9fTE9DS0VEICAgMHg0
MDAwCi0jZGVmaW5lIEJPX1BJTk5FRCAgIDB4MjAwMAorI2RlZmluZSBCT19MT0NLRUQgICAweDQw
MDAgICAvKiBvYmogbG9jayBpcyBoZWxkICovCisjZGVmaW5lIEJPX1BJTk5FRCAgIDB4MjAwMCAg
IC8qIG9iaiBpcyBwaW5uZWQgYW5kIG9uIGFjdGl2ZSBsaXN0ICovCiAKIHN0YXRpYyBzdHJ1Y3Qg
bXNtX2dlbV9zdWJtaXQgKnN1Ym1pdF9jcmVhdGUoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIAkJ
c3RydWN0IG1zbV9ncHUgKmdwdSwKQEAgLTIyMCwyMSArMjIwLDMzIEBAIHN0YXRpYyBpbnQgc3Vi
bWl0X2xvb2t1cF9jbWRzKHN0cnVjdCBtc21fZ2VtX3N1Ym1pdCAqc3VibWl0LAogCXJldHVybiBy
ZXQ7CiB9CiAKLXN0YXRpYyB2b2lkIHN1Ym1pdF91bmxvY2tfdW5waW5fYm8oc3RydWN0IG1zbV9n
ZW1fc3VibWl0ICpzdWJtaXQsCi0JCWludCBpLCBib29sIGJhY2tvZmYpCisvKiBVbndpbmQgYm8g
c3RhdGUsIGFjY29yZGluZyB0byBjbGVhbnVwX2ZsYWdzLiAgSW4gdGhlIHN1Y2Nlc3MgY2FzZSwg
b25seQorICogdGhlIGxvY2sgaXMgZHJvcHBlZCBhdCB0aGUgZW5kIG9mIHRoZSBzdWJtaXQgKGFu
ZCBhY3RpdmUvcGluIHJlZiBpcyBkcm9wcGVkCisgKiBsYXRlciB3aGVuIHRoZSBzdWJtaXQgaXMg
cmV0aXJlZCkuCisgKi8KK3N0YXRpYyB2b2lkIHN1Ym1pdF9jbGVhbnVwX2JvKHN0cnVjdCBtc21f
Z2VtX3N1Ym1pdCAqc3VibWl0LCBpbnQgaSwKKwkJdW5zaWduZWQgY2xlYW51cF9mbGFncykKIHsK
LQlzdHJ1Y3QgbXNtX2dlbV9vYmplY3QgKm1zbV9vYmogPSBzdWJtaXQtPmJvc1tpXS5vYmo7CisJ
c3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmogPSAmc3VibWl0LT5ib3NbaV0ub2JqLT5iYXNlOwor
CXVuc2lnbmVkIGZsYWdzID0gc3VibWl0LT5ib3NbaV0uZmxhZ3MgJiBjbGVhbnVwX2ZsYWdzOwog
Ci0JaWYgKHN1Ym1pdC0+Ym9zW2ldLmZsYWdzICYgQk9fUElOTkVEKQotCQltc21fZ2VtX3VucGlu
X2lvdmFfbG9ja2VkKCZtc21fb2JqLT5iYXNlLCBzdWJtaXQtPmFzcGFjZSk7CisJaWYgKGZsYWdz
ICYgQk9fUElOTkVEKSB7CisJCW1zbV9nZW1fdW5waW5faW92YV9sb2NrZWQob2JqLCBzdWJtaXQt
PmFzcGFjZSk7CisJCW1zbV9nZW1fYWN0aXZlX3B1dChvYmopOworCX0KIAotCWlmIChzdWJtaXQt
PmJvc1tpXS5mbGFncyAmIEJPX0xPQ0tFRCkKLQkJZG1hX3Jlc3ZfdW5sb2NrKG1zbV9vYmotPmJh
c2UucmVzdik7CisJaWYgKGZsYWdzICYgQk9fTE9DS0VEKQorCQlkbWFfcmVzdl91bmxvY2sob2Jq
LT5yZXN2KTsKIAotCWlmIChiYWNrb2ZmICYmICEoc3VibWl0LT5ib3NbaV0uZmxhZ3MgJiBCT19W
QUxJRCkpCi0JCXN1Ym1pdC0+Ym9zW2ldLmlvdmEgPSAwOworCXN1Ym1pdC0+Ym9zW2ldLmZsYWdz
ICY9IH5jbGVhbnVwX2ZsYWdzOworfQogCi0Jc3VibWl0LT5ib3NbaV0uZmxhZ3MgJj0gfihCT19M
T0NLRUQgfCBCT19QSU5ORUQpOworc3RhdGljIHZvaWQgc3VibWl0X3VubG9ja191bnBpbl9ibyhz
dHJ1Y3QgbXNtX2dlbV9zdWJtaXQgKnN1Ym1pdCwgaW50IGkpCit7CisJc3VibWl0X2NsZWFudXBf
Ym8oc3VibWl0LCBpLCBCT19QSU5ORUQgfCBCT19MT0NLRUQpOworCisJaWYgKCEoc3VibWl0LT5i
b3NbaV0uZmxhZ3MgJiBCT19WQUxJRCkpCisJCXN1Ym1pdC0+Ym9zW2ldLmlvdmEgPSAwOwogfQog
CiAvKiBUaGlzIGlzIHdoZXJlIHdlIG1ha2Ugc3VyZSBhbGwgdGhlIGJvJ3MgYXJlIHJlc2VydmVk
IGFuZCBwaW4nZDogKi8KQEAgLTI2NiwxMCArMjc4LDEwIEBAIHN0YXRpYyBpbnQgc3VibWl0X2xv
Y2tfb2JqZWN0cyhzdHJ1Y3QgbXNtX2dlbV9zdWJtaXQgKnN1Ym1pdCkKIAogZmFpbDoKIAlmb3Ig
KDsgaSA+PSAwOyBpLS0pCi0JCXN1Ym1pdF91bmxvY2tfdW5waW5fYm8oc3VibWl0LCBpLCB0cnVl
KTsKKwkJc3VibWl0X3VubG9ja191bnBpbl9ibyhzdWJtaXQsIGkpOwogCiAJaWYgKHNsb3dfbG9j
a2VkID4gMCkKLQkJc3VibWl0X3VubG9ja191bnBpbl9ibyhzdWJtaXQsIHNsb3dfbG9ja2VkLCB0
cnVlKTsKKwkJc3VibWl0X3VubG9ja191bnBpbl9ibyhzdWJtaXQsIHNsb3dfbG9ja2VkKTsKIAog
CWlmIChyZXQgPT0gLUVERUFETEspIHsKIAkJc3RydWN0IG1zbV9nZW1fb2JqZWN0ICptc21fb2Jq
ID0gc3VibWl0LT5ib3NbY29udGVuZGVkXS5vYmo7CkBAIC0zMjUsMTYgKzMzNywxOCBAQCBzdGF0
aWMgaW50IHN1Ym1pdF9waW5fb2JqZWN0cyhzdHJ1Y3QgbXNtX2dlbV9zdWJtaXQgKnN1Ym1pdCkK
IAlzdWJtaXQtPnZhbGlkID0gdHJ1ZTsKIAogCWZvciAoaSA9IDA7IGkgPCBzdWJtaXQtPm5yX2Jv
czsgaSsrKSB7Ci0JCXN0cnVjdCBtc21fZ2VtX29iamVjdCAqbXNtX29iaiA9IHN1Ym1pdC0+Ym9z
W2ldLm9iajsKKwkJc3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmogPSAmc3VibWl0LT5ib3NbaV0u
b2JqLT5iYXNlOwogCQl1aW50NjRfdCBpb3ZhOwogCiAJCS8qIGlmIGxvY2tpbmcgc3VjY2VlZGVk
LCBwaW4gYm86ICovCi0JCXJldCA9IG1zbV9nZW1fZ2V0X2FuZF9waW5faW92YV9sb2NrZWQoJm1z
bV9vYmotPmJhc2UsCisJCXJldCA9IG1zbV9nZW1fZ2V0X2FuZF9waW5faW92YV9sb2NrZWQob2Jq
LAogCQkJCXN1Ym1pdC0+YXNwYWNlLCAmaW92YSk7CiAKIAkJaWYgKHJldCkKIAkJCWJyZWFrOwog
CisJCW1zbV9nZW1fYWN0aXZlX2dldChvYmosIHN1Ym1pdC0+Z3B1KTsKKwogCQlzdWJtaXQtPmJv
c1tpXS5mbGFncyB8PSBCT19QSU5ORUQ7CiAKIAkJaWYgKGlvdmEgPT0gc3VibWl0LT5ib3NbaV0u
aW92YSkgewpAQCAtMzUwLDYgKzM2NCwyMCBAQCBzdGF0aWMgaW50IHN1Ym1pdF9waW5fb2JqZWN0
cyhzdHJ1Y3QgbXNtX2dlbV9zdWJtaXQgKnN1Ym1pdCkKIAlyZXR1cm4gcmV0OwogfQogCitzdGF0
aWMgdm9pZCBzdWJtaXRfYXR0YWNoX29iamVjdF9mZW5jZXMoc3RydWN0IG1zbV9nZW1fc3VibWl0
ICpzdWJtaXQpCit7CisJaW50IGk7CisKKwlmb3IgKGkgPSAwOyBpIDwgc3VibWl0LT5ucl9ib3M7
IGkrKykgeworCQlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiA9ICZzdWJtaXQtPmJvc1tpXS5v
YmotPmJhc2U7CisKKwkJaWYgKHN1Ym1pdC0+Ym9zW2ldLmZsYWdzICYgTVNNX1NVQk1JVF9CT19X
UklURSkKKwkJCWRtYV9yZXN2X2FkZF9leGNsX2ZlbmNlKG9iai0+cmVzdiwgc3VibWl0LT5mZW5j
ZSk7CisJCWVsc2UgaWYgKHN1Ym1pdC0+Ym9zW2ldLmZsYWdzICYgTVNNX1NVQk1JVF9CT19SRUFE
KQorCQkJZG1hX3Jlc3ZfYWRkX3NoYXJlZF9mZW5jZShvYmotPnJlc3YsIHN1Ym1pdC0+ZmVuY2Up
OworCX0KK30KKwogc3RhdGljIGludCBzdWJtaXRfYm8oc3RydWN0IG1zbV9nZW1fc3VibWl0ICpz
dWJtaXQsIHVpbnQzMl90IGlkeCwKIAkJc3RydWN0IG1zbV9nZW1fb2JqZWN0ICoqb2JqLCB1aW50
NjRfdCAqaW92YSwgYm9vbCAqdmFsaWQpCiB7CkBAIC00NDQsMTggKzQ3Miw0MCBAQCBzdGF0aWMg
aW50IHN1Ym1pdF9yZWxvYyhzdHJ1Y3QgbXNtX2dlbV9zdWJtaXQgKnN1Ym1pdCwgc3RydWN0IG1z
bV9nZW1fb2JqZWN0ICpvYgogCXJldHVybiByZXQ7CiB9CiAKLXN0YXRpYyB2b2lkIHN1Ym1pdF9j
bGVhbnVwKHN0cnVjdCBtc21fZ2VtX3N1Ym1pdCAqc3VibWl0KQorLyogQ2xlYW51cCBzdWJtaXQg
YXQgZW5kIG9mIGlvY3RsLiAgSW4gdGhlIGVycm9yIGNhc2UsIHRoaXMgYWxzbyBkcm9wcworICog
cmVmZXJlbmNlcywgdW5waW5zLCBhbmQgZHJvcHMgYWN0aXZlIHJlZmNudC4gIEluIHRoZSBub24t
ZXJyb3IgY2FzZSwKKyAqIHRoaXMgaXMgZG9uZSB3aGVuIHRoZSBzdWJtaXQgaXMgcmV0aXJlZC4K
KyAqLworc3RhdGljIHZvaWQgc3VibWl0X2NsZWFudXAoc3RydWN0IG1zbV9nZW1fc3VibWl0ICpz
dWJtaXQsIGJvb2wgZXJyb3IpCiB7CisJdW5zaWduZWQgY2xlYW51cF9mbGFncyA9IEJPX0xPQ0tF
RDsKIAl1bnNpZ25lZCBpOwogCisJaWYgKGVycm9yKQorCQljbGVhbnVwX2ZsYWdzIHw9IEJPX1BJ
Tk5FRDsKKwogCWZvciAoaSA9IDA7IGkgPCBzdWJtaXQtPm5yX2JvczsgaSsrKSB7CiAJCXN0cnVj
dCBtc21fZ2VtX29iamVjdCAqbXNtX29iaiA9IHN1Ym1pdC0+Ym9zW2ldLm9iajsKLQkJc3VibWl0
X3VubG9ja191bnBpbl9ibyhzdWJtaXQsIGksIGZhbHNlKTsKKwkJc3VibWl0X2NsZWFudXBfYm8o
c3VibWl0LCBpLCBjbGVhbnVwX2ZsYWdzKTsKIAkJbGlzdF9kZWxfaW5pdCgmbXNtX29iai0+c3Vi
bWl0X2VudHJ5KTsKLQkJZHJtX2dlbV9vYmplY3RfcHV0KCZtc21fb2JqLT5iYXNlKTsKKwkJaWYg
KGVycm9yKQorCQkJZHJtX2dlbV9vYmplY3RfcHV0KCZtc21fb2JqLT5iYXNlKTsKIAl9CiB9CiAK
K3ZvaWQgbXNtX3N1Ym1pdF9yZXRpcmUoc3RydWN0IG1zbV9nZW1fc3VibWl0ICpzdWJtaXQpCit7
CisJaW50IGk7CisKKwlmb3IgKGkgPSAwOyBpIDwgc3VibWl0LT5ucl9ib3M7IGkrKykgeworCQlz
dHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiA9ICZzdWJtaXQtPmJvc1tpXS5vYmotPmJhc2U7CisK
KwkJbXNtX2dlbV9sb2NrKG9iaik7CisJCXN1Ym1pdF9jbGVhbnVwX2JvKHN1Ym1pdCwgaSwgQk9f
UElOTkVEKTsKKwkJbXNtX2dlbV91bmxvY2sob2JqKTsKKwkJZHJtX2dlbV9vYmplY3RfcHV0KG9i
aik7CisJfQorfQogCiBzdHJ1Y3QgbXNtX3N1Ym1pdF9wb3N0X2RlcCB7CiAJc3RydWN0IGRybV9z
eW5jb2JqICpzeW5jb2JqOwpAQCAtODMyLDYgKzg4Miw4IEBAIGludCBtc21faW9jdGxfZ2VtX3N1
Ym1pdChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCQlhcmdzLT5mZW5jZV9m
ZCA9IG91dF9mZW5jZV9mZDsKIAl9CiAKKwlzdWJtaXRfYXR0YWNoX29iamVjdF9mZW5jZXMoc3Vi
bWl0KTsKKwogCW1zbV9ncHVfc3VibWl0KGdwdSwgc3VibWl0KTsKIAogCWFyZ3MtPmZlbmNlID0g
c3VibWl0LT5mZW5jZS0+c2Vxbm87CkBAIC04NDQsNyArODk2LDcgQEAgaW50IG1zbV9pb2N0bF9n
ZW1fc3VibWl0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsCiBvdXQ6CiAJcG1f
cnVudGltZV9wdXQoJmdwdS0+cGRldi0+ZGV2KTsKIG91dF9wcmVfcG06Ci0Jc3VibWl0X2NsZWFu
dXAoc3VibWl0KTsKKwlzdWJtaXRfY2xlYW51cChzdWJtaXQsICEhcmV0KTsKIAlpZiAoaGFzX3d3
X3RpY2tldCkKIAkJd3dfYWNxdWlyZV9maW5pKCZzdWJtaXQtPnRpY2tldCk7CiAJbXNtX2dlbV9z
dWJtaXRfcHV0KHN1Ym1pdCk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vbXNtL21zbV9n
cHUuYyBiL2RyaXZlcnMvZ3B1L2RybS9tc20vbXNtX2dwdS5jCmluZGV4IGEwNTg5NjY2YjFhMy4u
NWJmYzRkMjRhOTU2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vbXNtL21zbV9ncHUuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vbXNtL21zbV9ncHUuYwpAQCAtNjQ3LDcgKzY0Nyw2IEBAIHN0
YXRpYyB2b2lkIHJldGlyZV9zdWJtaXQoc3RydWN0IG1zbV9ncHUgKmdwdSwgc3RydWN0IG1zbV9y
aW5nYnVmZmVyICpyaW5nLAogCXZvbGF0aWxlIHN0cnVjdCBtc21fZ3B1X3N1Ym1pdF9zdGF0cyAq
c3RhdHM7CiAJdTY0IGVsYXBzZWQsIGNsb2NrID0gMDsKIAl1bnNpZ25lZCBsb25nIGZsYWdzOwot
CWludCBpOwogCiAJc3RhdHMgPSAmcmluZy0+bWVtcHRycy0+c3RhdHNbaW5kZXhdOwogCS8qIENv
bnZlcnQgMTkuMk1oeiBhbHdheXNvbiB0aWNrcyB0byBuYW5vc2Vjb25kcyBmb3IgZWxhcHNlZCB0
aW1lICovCkBAIC02NjMsMTUgKzY2Miw3IEBAIHN0YXRpYyB2b2lkIHJldGlyZV9zdWJtaXQoc3Ry
dWN0IG1zbV9ncHUgKmdwdSwgc3RydWN0IG1zbV9yaW5nYnVmZmVyICpyaW5nLAogCXRyYWNlX21z
bV9ncHVfc3VibWl0X3JldGlyZWQoc3VibWl0LCBlbGFwc2VkLCBjbG9jaywKIAkJc3RhdHMtPmFs
d2F5c29uX3N0YXJ0LCBzdGF0cy0+YWx3YXlzb25fZW5kKTsKIAotCWZvciAoaSA9IDA7IGkgPCBz
dWJtaXQtPm5yX2JvczsgaSsrKSB7Ci0JCXN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqID0gJnN1
Ym1pdC0+Ym9zW2ldLm9iai0+YmFzZTsKLQotCQltc21fZ2VtX2xvY2sob2JqKTsKLQkJbXNtX2dl
bV9hY3RpdmVfcHV0KG9iaik7Ci0JCW1zbV9nZW1fdW5waW5faW92YV9sb2NrZWQob2JqLCBzdWJt
aXQtPmFzcGFjZSk7Ci0JCW1zbV9nZW1fdW5sb2NrKG9iaik7Ci0JCWRybV9nZW1fb2JqZWN0X3B1
dChvYmopOwotCX0KKwltc21fc3VibWl0X3JldGlyZShzdWJtaXQpOwogCiAJcG1fcnVudGltZV9t
YXJrX2xhc3RfYnVzeSgmZ3B1LT5wZGV2LT5kZXYpOwogCXBtX3J1bnRpbWVfcHV0X2F1dG9zdXNw
ZW5kKCZncHUtPnBkZXYtPmRldik7CkBAIC03NDgsNyArNzM5LDYgQEAgdm9pZCBtc21fZ3B1X3N1
Ym1pdChzdHJ1Y3QgbXNtX2dwdSAqZ3B1LCBzdHJ1Y3QgbXNtX2dlbV9zdWJtaXQgKnN1Ym1pdCkK
IAlzdHJ1Y3QgbXNtX2RybV9wcml2YXRlICpwcml2ID0gZGV2LT5kZXZfcHJpdmF0ZTsKIAlzdHJ1
Y3QgbXNtX3JpbmdidWZmZXIgKnJpbmcgPSBzdWJtaXQtPnJpbmc7CiAJdW5zaWduZWQgbG9uZyBm
bGFnczsKLQlpbnQgaTsKIAogCVdBUk5fT04oIW11dGV4X2lzX2xvY2tlZCgmZGV2LT5zdHJ1Y3Rf
bXV0ZXgpKTsKIApAQCAtNzYyLDIzICs3NTIsNiBAQCB2b2lkIG1zbV9ncHVfc3VibWl0KHN0cnVj
dCBtc21fZ3B1ICpncHUsIHN0cnVjdCBtc21fZ2VtX3N1Ym1pdCAqc3VibWl0KQogCiAJdXBkYXRl
X3N3X2NudHJzKGdwdSk7CiAKLQlmb3IgKGkgPSAwOyBpIDwgc3VibWl0LT5ucl9ib3M7IGkrKykg
ewotCQlzdHJ1Y3QgbXNtX2dlbV9vYmplY3QgKm1zbV9vYmogPSBzdWJtaXQtPmJvc1tpXS5vYmo7
Ci0JCXN0cnVjdCBkcm1fZ2VtX29iamVjdCAqZHJtX29iaiA9ICZtc21fb2JqLT5iYXNlOwotCQl1
aW50NjRfdCBpb3ZhOwotCi0JCS8qIHN1Ym1pdCB0YWtlcyBhIHJlZmVyZW5jZSB0byB0aGUgYm8g
YW5kIGlvdmEgdW50aWwgcmV0aXJlZDogKi8KLQkJZHJtX2dlbV9vYmplY3RfZ2V0KCZtc21fb2Jq
LT5iYXNlKTsKLQkJbXNtX2dlbV9nZXRfYW5kX3Bpbl9pb3ZhX2xvY2tlZCgmbXNtX29iai0+YmFz
ZSwgc3VibWl0LT5hc3BhY2UsICZpb3ZhKTsKLQotCQlpZiAoc3VibWl0LT5ib3NbaV0uZmxhZ3Mg
JiBNU01fU1VCTUlUX0JPX1dSSVRFKQotCQkJZG1hX3Jlc3ZfYWRkX2V4Y2xfZmVuY2UoZHJtX29i
ai0+cmVzdiwgc3VibWl0LT5mZW5jZSk7Ci0JCWVsc2UgaWYgKHN1Ym1pdC0+Ym9zW2ldLmZsYWdz
ICYgTVNNX1NVQk1JVF9CT19SRUFEKQotCQkJZG1hX3Jlc3ZfYWRkX3NoYXJlZF9mZW5jZShkcm1f
b2JqLT5yZXN2LCBzdWJtaXQtPmZlbmNlKTsKLQotCQltc21fZ2VtX2FjdGl2ZV9nZXQoZHJtX29i
aiwgZ3B1KTsKLQl9Ci0KIAkvKgogCSAqIHJpbmctPnN1Ym1pdHMgaG9sZHMgYSByZWYgdG8gdGhl
IHN1Ym1pdCwgdG8gZGVhbCB3aXRoIHRoZSBjYXNlCiAJICogdGhhdCBhIHN1Ym1pdCBjb21wbGV0
ZXMgYmVmb3JlIG1zbV9pb2N0bF9nZW1fc3VibWl0KCkgcmV0dXJucy4KLS0gCjIuMzEuMQoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KRnJlZWRyZW5vIG1h
aWxpbmcgbGlzdApGcmVlZHJlbm9AbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZnJlZWRyZW5vCg==
