Return-Path: <freedreno-bounces@lists.freedesktop.org>
X-Original-To: lists+freedreno@lfdr.de
Delivered-To: lists+freedreno@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id B179083C360
	for <lists+freedreno@lfdr.de>; Thu, 25 Jan 2024 14:13:21 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8341110F8C3;
	Thu, 25 Jan 2024 13:13:20 +0000 (UTC)
X-Original-To: freedreno@lists.freedesktop.org
Delivered-To: freedreno@lists.freedesktop.org
Received: from mail-wr1-f47.google.com (mail-wr1-f47.google.com
 [209.85.221.47])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 459CD10F8BF
 for <freedreno@lists.freedesktop.org>; Thu, 25 Jan 2024 13:13:19 +0000 (UTC)
Received: by mail-wr1-f47.google.com with SMTP id
 ffacd0b85a97d-339231c062bso4726053f8f.0
 for <freedreno@lists.freedesktop.org>; Thu, 25 Jan 2024 05:13:19 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20230601; t=1706188337; x=1706793137; darn=lists.freedesktop.org;
 h=content-transfer-encoding:mime-version:message-id:date:subject:cc
 :to:from:from:to:cc:subject:date:message-id:reply-to;
 bh=B7PODPqhJhHRMFMk/4hcyt7GbdXaKvsvK5R9ploJxGg=;
 b=L8NzOYSn0w0+EJRiylarJXJffWWQHK1eUWIpxk9/u+DGN/8mjt9+9rqTq2MAI6ZAvz
 V8VeZ9opGGQS6bj5fvjB6y4r6jfsbJaLK+shBOX6Y3tHR4Cs0rwBzB5ttlGdaj9h9+L9
 Vl6sfHoNekBTrRjuSLbUHEOGVO9V6BNwuIPIr5SXodh+nRaTlv8ZqI3CUcbjBE1o0vUC
 BpX486EG4a1xWloqFnAKhv49adurEzkRA+T8yZY2i7N8FRNtwpfU5U0B1IlRh/071Fxp
 XjcqTE3KLEtc8AfmRYC0R/SKkAgYYwjQW7YE+SRWmOEUUv3VOr+SmduUj/MNflVhYZc4
 jHGw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20230601; t=1706188337; x=1706793137;
 h=content-transfer-encoding:mime-version:message-id:date:subject:cc
 :to:from:x-gm-message-state:from:to:cc:subject:date:message-id
 :reply-to;
 bh=B7PODPqhJhHRMFMk/4hcyt7GbdXaKvsvK5R9ploJxGg=;
 b=KKo5N4+VoVHPc3zDBkvjKilyU3n2RnCPoYHgnlqqSTjsdWVhHuDNOyXO7D3P98y10X
 kQ73jeTfO5iAxRB6Y3W0nnD03fGQJS8qoIbHNTuSntLaIyr9TvIo+xjkTBQN2R3FxO2U
 hxVOuNRVq6Tpew6U+MvBdG9LIx5FiQIvluetOSaQm+qR2XR5x7rc+efiS0UGdc5b3l4y
 OczWFEpwywNNvbU5uFOdnHM6Df/+OvnmLo8bTE0dD/gI3+6ZkbAs2WToRqeFv3n9HFK7
 54UdwC1tDA7rpFcSvEWmpksTU9LHtHc+GdZKgX0cnYKvWzf9DGfWeX3lpsh00ZWP57Uz
 BULg==
X-Gm-Message-State: AOJu0Yy1/tanUjwkLeIHw6ZbcVPvLshn1Ww7CL+IzBF4rnI8Poktn/ty
 qvPbU9WQGbA5GZBxz5OgJMJpl/mmAWbHVBs/HCcrKUUm+vpye8/SNHaKaA0FXO8=
X-Google-Smtp-Source: AGHT+IEHy9i+CPvhlfczS5LC3McXBp9MJCgSE45FtSfjosUjndCPJ0ns/o0rytn9n7Ob+kOwzfEAhA==
X-Received: by 2002:a5d:6a10:0:b0:337:b402:afaa with SMTP id
 m16-20020a5d6a10000000b00337b402afaamr543088wru.33.1706188336950; 
 Thu, 25 Jan 2024 05:12:16 -0800 (PST)
Received: from lucy.. (cpc115152-dals23-2-0-cust532.20-2.cable.virginm.net.
 [86.12.82.21]) by smtp.gmail.com with ESMTPSA id
 s17-20020a5d4251000000b00337d84efaf7sm17076114wrr.74.2024.01.25.05.12.16
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Thu, 25 Jan 2024 05:12:16 -0800 (PST)
From: Connor Abbott <cwabbott0@gmail.com>
To: freedreno@lists.freedesktop.org
Subject: [PATCH 0/5] drm/msm: More complete devcoredump support for a7xx
Date: Thu, 25 Jan 2024 13:10:53 +0000
Message-Id: <20240125131058.2084628-1-cwabbott0@gmail.com>
X-Mailer: git-send-email 2.31.1
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-BeenThere: freedreno@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Freedreno graphics driver community testing & development
 <freedreno.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/freedreno>,
 <mailto:freedreno-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/freedreno>
List-Post: <mailto:freedreno@lists.freedesktop.org>
List-Help: <mailto:freedreno-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/freedreno>,
 <mailto:freedreno-request@lists.freedesktop.org?subject=subscribe>
Cc: Rob Clark <robdclark@chromium.org>, Connor Abbott <cwabbott0@gmail.com>
Errors-To: freedreno-bounces@lists.freedesktop.org
Sender: "Freedreno" <freedreno-bounces@lists.freedesktop.org>

The current devcoredump support on a7xx is quite limited. Downstream,
there are now autogenerated register headers for each generation (a730,
a740, and a750), which means that we must try to re-use them as much as
possible instead of reinventing our own register list descriptions as
was done on a6xx. In addition, due to changes like:

- The addition of the BV and LPAC pipes.
- The addition of a VPC_PS cluster.
- Some clusters having 4 contexts instead of 2.
- HLSQ and SP registers getting merged, so the same register can now
  be stored separately in HLSQ, SP "top", and each uSPTP (this also made
  the HLSQ registers get shuffled around into SP).

how we capture cluster registers needs to be significantly different.

The downstream code seems to depend on a "regmap" that takes various
disparate register spaces (like cx_misc aka cx_mem, cx_dbgc, gmu, etc.)
defined in devicetree and pretends they are enlargements of the "base"
register space at 3d00000. For now we don't dump the problematic
register lists, but we'll need to come up with a solution for proplerly
dumping GMU registers and what downstream calls "external core"
registers.

It seems that the debugbus hasn't changed much, however I cannot test it
because it seems either the debugbus is fused off on HDK8550 or I'm
doing something wrong - it returns all 0.

Initial crashdec support will come in a mesa MR.

This series depends on [1] to avoid conflicts. The updated registers
in the second commit come from [2] in mesa. The kgsl headers in the
first commit come from [3] (I have no idea how their release scheme
works, but it seems most branches have the same contents for these
files).

[1] https://patchwork.freedesktop.org/series/128902/
[2] https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/27264
[3] https://git.codelinaro.org/clo/la/platform/vendor/qcom/opensource/graphics-kernel/-/tree/gfx-auto-kernel.lnx.1.0.r8-rel?ref_type=heads

Connor Abbott (5):
  drm/msm: Import a7xx crashdump register lists from kgsl
  drm/msm/adreno: Update a6xx headers for a7xx devcoredump
  drm/msm: Fix snapshotting a7xx indexed regs
  drm/msm: More fully implement devcoredump for a7xx
  drm/msm: Fix page fault client detection on a660 family and a7xx

 drivers/gpu/drm/msm/adreno/a6xx.xml.h         | 785 ++++++++++-----
 drivers/gpu/drm/msm/adreno/a6xx_gpu.c         |  95 +-
 drivers/gpu/drm/msm/adreno/a6xx_gpu_state.c   | 727 ++++++++++++--
 drivers/gpu/drm/msm/adreno/a6xx_gpu_state.h   | 311 +++++-
 .../drm/msm/adreno/adreno_gen7_0_0_snapshot.h | 928 ++++++++++++++++++
 .../drm/msm/adreno/adreno_gen7_2_0_snapshot.h | 753 ++++++++++++++
 6 files changed, 3235 insertions(+), 364 deletions(-)
 create mode 100644 drivers/gpu/drm/msm/adreno/adreno_gen7_0_0_snapshot.h
 create mode 100644 drivers/gpu/drm/msm/adreno/adreno_gen7_2_0_snapshot.h

-- 
2.31.1

